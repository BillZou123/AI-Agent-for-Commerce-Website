<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Welcome to BIER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =============================
       THEME & GLOBAL LAYOUT
       - Defines colors, fonts, page width, and a subtle emoji-ish wallpaper
       ============================= */
    :root{
      --bg:#f7f8ff; --card:#fff; --muted:#667085; --line:#e6e8f0;
      --user:#e8f0fe; --bot:#f5f5f7; --ink:#111827;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width: 1040px;
      margin: 40px auto;
      padding: 0 20px;
      color:#111;
      background:
        radial-gradient(circle at 24px 24px, #e9ecff 2px, transparent 3px) 0 0/48px 48px,
        radial-gradient(circle at 12px 12px, #f2f4ff 2px, transparent 3px) 0 0/48px 48px,
        var(--bg);
    }

    /* =============================
       HEADER (title + cute avatar)
       ============================= */
    .header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .avatar{
      width:40px;height:40px;border-radius:50%;display:grid;place-items:center;
      font-size:22px;background:#fff;border:1px solid var(--line); box-shadow:0 1px 0 rgba(0,0,0,.03)
    }
    h1{margin:0}

    /* =============================
       PANEL (frame that holds chat + stickers)
       ============================= */
    .panel{
      position:relative;
      border-radius:16px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:0 6px 24px rgba(17,24,39,.06);
      padding:18px;
      overflow:hidden;
    }

    /* Floating decorative stickers (pure emoji, non-interactive) */
    .stickers span{
      position:absolute; font-size:28px; opacity:.22; user-select:none; pointer-events:none;
      animation: float 9s ease-in-out infinite;
    }
    .stickers .s1{top:-6px; left:14px;  animation-delay:0s}
    .stickers .s2{top:8px;  right:18px; animation-delay:1.2s}
    .stickers .s3{bottom:8px; left:22px; animation-delay:2.1s}
    .stickers .s4{bottom:-4px;right:24px; animation-delay:.6s}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

    /* =============================
       CHAT AREA (scrollable history)
       ============================= */
    .chat{
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      height: 68vh;             /* tall chat window */
      min-height: 520px;        /* keeps size on short screens */
      overflow-y:auto;
      display:flex; flex-direction:column; gap:8px;
      background:var(--card);
    }
    .bubble{padding:10px 12px; border-radius:12px; max-width:86%; white-space:pre-wrap; word-break:break-word;}
    .user{background:var(--user); align-self:flex-end;}
    .bot{ background:var(--bot);  align-self:flex-start;}
    .bubble img{max-width:280px; max-height:220px; border-radius:8px; display:block}

    /* =============================
       CATALOG CARDS (grid render of product results)
       ============================= */
    .catalog-header{font-weight:600;margin:0 0 8px;color:#222}
    .catalog-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:12px; }
    .catalog-card { border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px; }
    .catalog-card img { width:100%; height:140px; object-fit:cover; border-radius:8px; display:block; }
    .catalog-title { margin-top:8px; font-weight:600; }
    .catalog-meta { color:var(--muted); font-size:12px; margin-top:2px; }
    .catalog-idx { font-weight:700; margin-bottom:6px; color:#555; }

    /* =============================
       COMPOSER (input row with attach + send)
       ============================= */
    .composer{display:flex; gap:10px; align-items:center; margin-top:12px}
    .box{
      flex:1; display:flex; align-items:center; gap:8px; border:1px solid var(--line);
      background:var(--card); border-radius:14px; padding:10px 12px
    }
    .attach-btn{border:0; background:transparent; font-size:26px; cursor:pointer; line-height:1; color:#060910}
    .attach-btn:hover{color:#000}
    .box input[type="text"]{flex:1; border:0; outline:none; font-size:16px; background:transparent}
    .send-btn{
      width:48px;height:48px;border-radius:50%;border:0;background:var(--ink);color:#fff;
      font-size:18px;cursor:pointer;display:grid;place-items:center; box-shadow:0 3px 10px rgba(17,24,39,.18)
    }
    .send-btn[disabled]{opacity:.7; cursor:not-allowed}
    #img{display:none} /* hidden file input */

    /* Chip preview for selected image inside composer */
    .chip{display:flex;align-items:center;gap:6px;padding:4px 6px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .chip img{width:28px;height:28px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6}
    .chip button{border:0;background:transparent;color:#b91c1c;cursor:pointer;font-size:14px;line-height:1}
    .hidden{display:none}

    /* Typing indicator & basic animations */
    .typing { color:#555; font-size:13px; }
    .dots{ display:inline-flex; gap:4px; vertical-align:middle; margin-left:4px }
    .dot{ width:6px; height:6px; border-radius:50%; background:#888; opacity:.6; animation: bounce 1s infinite ease-in-out }
    .dot:nth-child(2){ animation-delay:.15s }
    .dot:nth-child(3){ animation-delay:.3s }
    @keyframes bounce{0%,80%,100%{transform: translateY(0); opacity:.6}40%{transform: translateY(-4px); opacity:1}}
    .pop { animation: popin .18s ease-out both }
    @keyframes popin{from{transform:scale(.97) translateY(6px); opacity:.0}to{transform:scale(1) translateY(0); opacity:1}}

    /* Hidden node to hold session id (used by JS, invisible to users) */
    .meta{display:none}
  </style>
</head>
<body>
  <!-- =============================
       HEADER (title + mascot)
       ============================= -->
  <div class="header">
    <div class="avatar" aria-hidden="true">üêª</div>
    <h1>Hi! Welcome to BiBi </h1>
  </div>

  <!-- =============================
       MAIN PANEL (chat container + floating stickers)
       ============================= -->
  <div class="panel">
    <div class="stickers" aria-hidden="true">
      <span class="s1">üêª</span>
      <span class="s2">üå∏</span>
      <span class="s3">‚≠êÔ∏è</span>
      <span class="s4">üß∏</span>
    </div>

    <!-- Chat history -->
    <div id="chat" class="chat" aria-label="Chat history"></div>

    <!-- Composer: attach, preview chip, text input, send -->
    <div class="composer">
      <div class="box">
        <button id="attach" class="attach-btn" title="Attach image" aria-label="Attach image">üìé</button>

        <!-- Tiny thumbnail chip preview -->
        <div id="chip" class="chip hidden" aria-live="polite">
          <img id="chipImg" alt="selected image preview">
          <button id="chipX" title="Remove">‚úï</button>
        </div>

        <input id="inp" type="text" placeholder="Say something‚Ä¶" aria-label="Message input" />
      </div>
      <button id="send" class="send-btn" aria-label="Send message">‚Æï</button>
      <input id="img" type="file" accept="image/*" />
    </div>
  </div>

  <!-- Session id (hidden but available to JS) -->
  <div class="meta">Session: <code id="sid"></code></div>

  <script>
    // =============================
    // SESSION MANAGEMENT
    // - Persistent session id per browser (stored in localStorage)
    // =============================
    let sessionId = localStorage.getItem('session_id');
    if (!sessionId) {
      sessionId = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
      localStorage.setItem('session_id', sessionId);
    }
    document.getElementById('sid').textContent = sessionId;

    // =============================
    // DOM REFERENCES
    // =============================
    const chat   = document.getElementById('chat');
    const inp    = document.getElementById('inp');
    const send   = document.getElementById('send');
    const img    = document.getElementById('img');
    const attach = document.getElementById('attach');

    const chip   = document.getElementById('chip');
    const chipImg= document.getElementById('chipImg');
    const chipX  = document.getElementById('chipX');

    let pendingFile = null;

    // =============================
    // CHAT HELPERS (render bubbles + autoscroll + typing)
    // =============================
    function autoscroll(){ chat.scrollTop = chat.scrollHeight; }

    function addTextBubble(text, who){
      const div = document.createElement('div');
      div.className = `bubble ${who} pop`;
      div.textContent = text;
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    function addImageBubble(url, who, alt='image'){
      const div = document.createElement('div');
      div.className = `bubble ${who} pop`;
      const im = document.createElement('img');
      im.src = url; im.alt = alt;
      div.appendChild(im);
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    // Temporary "thinking..." bubble that gets replaced by the real reply
    function showTypingBubble(){
      const div = document.createElement('div');
      div.className = 'bubble bot typing pop';
      div.innerHTML = `Thinking<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    // =============================
    // FILE ATTACHMENTS (open picker, show/remove chip)
    // =============================
    attach.addEventListener('click', () => img.click());

    function showChip(file){
      if(!file) return;
      pendingFile = file;
      chipImg.src = URL.createObjectURL(file);
      chip.classList.remove('hidden');
    }
    function clearChip(){
      pendingFile = null;
      chipImg.src = '';
      chip.classList.add('hidden');
      img.value = '';
    }
    chipX.addEventListener('click', clearChip);

    img.addEventListener('change', () => {
      const f = img.files && img.files[0] ? img.files[0] : null;
      if (f && f.type.startsWith('image/')) showChip(f);
    });

    // =============================
    // SEND MESSAGE FLOW
    // - Optimistic user bubble(s)
    // - Upload image if present
    // - POST /chat
    // - Replace typing bubble with final reply
    // =============================
    async function sendMessage(){
      const text = inp.value.trim();
      const file = pendingFile;

      if (!text && !file) return;

      // Optimistic user rendering
      if (text) addTextBubble(text, 'user');
      if (file) addImageBubble(URL.createObjectURL(file), 'user', file.name);

      inp.value = '';
      send.disabled = true;

      // Upload the image first (if any)
      let imageUrl = null;
      if (file) {
        const fd = new FormData();
        fd.append('image', file);
        try{
          const up = await fetch('/upload', { method:'POST', body: fd });
          const udata = await up.json();
          if (udata && udata.url) imageUrl = udata.url;
        }catch(e){
          console.error('upload failed', e);
          addTextBubble('Image upload failed.', 'bot');
          send.disabled = false; inp.focus();
          return;
        }
        clearChip();
      }

      // Show typing indicator immediately
      const typing = showTypingBubble();

      try{
        const res = await fetch('/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: text, session_id: sessionId, image_url: imageUrl })
        });
        const data = await res.json();

        if (data.session_id && data.session_id !== sessionId) {
          sessionId = data.session_id; localStorage.setItem('session_id', sessionId);
          document.getElementById('sid').textContent = sessionId;
        }
        const replyText = data.reply || '(no reply)';
        const cleanReply = stripJsonBlocks(replyText);
        typing.className = 'bubble bot pop';
        typing.textContent = cleanReply;

        // Prefer structured items from backend
        if (Array.isArray(data.items) && data.items.length > 0) {
          renderCardsFromItems(typing, data.items, '');
        } else {
          // Fall back to text or numbered block parsing
          if (!tryRenderNumberedCatalog(typing, replyText)) {
            typing.className = 'bubble bot pop';
            typing.textContent = cleanReply;
          }
        }
      }catch(e){
        console.error(e);
        typing.className = 'bubble bot pop';
        typing.textContent = 'Error contacting server.';
      }finally{
        send.disabled = false; inp.focus();
      }
    }
// Render product cards from backend `items`
    function renderCardsFromItems(typingDiv, items, headerText = ''){
      const bubble = document.createElement('div');
      bubble.className = 'bubble bot pop';

      const head = document.createElement('div');
      head.className = 'catalog-header';
      head.textContent = headerText;
      bubble.appendChild(head);

      const grid = document.createElement('div'); grid.className = 'catalog-grid';
      items.forEach((it, idx) => {
        const card = document.createElement('div'); card.className = 'catalog-card';

        const idxEl = document.createElement('div');
        idxEl.className = 'catalog-idx'; idxEl.textContent = `${idx+1}.`;

        const im = document.createElement('img');
        im.src = it.image || '/uploads/placeholder.jpg';
        im.alt = it.name || 'product';

        const title = document.createElement('div'); title.className = 'catalog-title';
        title.textContent = it.name || 'Unnamed';

        const meta = document.createElement('div'); meta.className = 'catalog-meta';
        const price = (it.price !== undefined && it.price !== null) ? `$${it.price}` : '';
        meta.textContent = [price, it.category].filter(Boolean).join(' ‚Ä¢ ');

        card.appendChild(idxEl); card.appendChild(im); card.appendChild(title); card.appendChild(meta);
        grid.appendChild(card);
      });

      bubble.appendChild(grid);
       // insert AFTER the anchor bubble
      typingDiv.insertAdjacentElement('afterend', bubble);
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 0);
    }

   
    function tryRenderNumberedCatalog(typingDiv, replyText) {
      if (!replyText) return false;
      const rawLines = replyText.split('\n').map(l => l.trim()).filter(Boolean);
      if (!rawLines.length) return false;

      let i = 0;
      if (/^\(query:\s*.+\)$/i.test(rawLines[0])) i = 1;
      const headerLine = rawLines[i] || "";
      const isTextHeader  = /^Here are some picks from my catalog:/i.test(headerLine);
      const isImageHeader = /^Here are some picks from my catalog based on the image you provided:/i.test(headerLine);
      if (!isTextHeader && !isImageHeader) return false;

      const itemLines = rawLines.slice(i + 1);
      const re = /^\s*(\d+)\.\s+\*\*(.+?)\*\*(?:\s+‚Äî\s+\$?([\d.]+))?(?:\s+¬∑\s+([^(]+?))?\s+\(image:\s*(.+?)\s*\)\s*$/;

      const items = [];
      for (const line of itemLines) {
        const m = line.match(re);
        if (!m) continue;
        const idx = m[1], name = m[2];
        const price = m[3] ? Number(m[3]) : null;
        const brandOrCat = (m[4] || '').trim();
        const img = m[5];
        items.push({ id: `${idx}`, name, price, category: brandOrCat, image: img });
      }
      if (!items.length) return false;

      renderCardsFromItems(typingDiv, items, headerLine);
      return true;
    }

    function stripJsonBlocks(text) {
      // Remove fenced code blocks like ```json ... ```
      text = text.replace(/```json[\s\S]*?```/gi, '').trim();

      // Optionally remove standalone { ... } JSON blobs
      text = text.replace(/\{[\s\S]*?\}/g, '').trim();

      return text;
    }

    // =============================
    // EVENTS
    // =============================
    send.addEventListener('click', sendMessage);
    inp.addEventListener('keydown', (e) => e.key === 'Enter' && sendMessage());

    // =============================
    // INITIAL GREETING
    // =============================
    addTextBubble('üëã Hello! I am BiBi, your personal shopping assistant.\nHow can I help you today? üòò', 'bot');
    setTimeout(() => {
      addTextBubble("‚ú® Here‚Äôs what I can do:\n1Ô∏è‚É£ Chat with you about anything üó£Ô∏è\n2Ô∏è‚É£ Suggest awesome products üéÅ from my catalog \n3Ô∏è‚É£ Search products by image üîç Just upload and I‚Äôll find it!", 'bot');
    }, 800);
  </script>
</body>
</html>