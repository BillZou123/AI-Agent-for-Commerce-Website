<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Welcome to BIER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .catalog-header{font-weight:600;margin:0 0 8px;color:#222}
    .catalog-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:12px; }
    .catalog-card { border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px; }
    .catalog-card img { width:100%; height:130px; object-fit:cover; border-radius:8px; display:block; }
    .catalog-title { margin-top:8px; font-weight:600; }
    .catalog-meta { color:var(--muted); font-size:12px; margin-top:2px; }
    .catalog-idx { font-weight:700; margin-bottom:6px; color:#555; }
    :root{
      --bg:#f8f8f8; --card:#fff; --muted:#666; --line:#e6e6e6;
      --user:#e8f0fe; --bot:#f5f5f5; --ink:#111827;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width:760px; margin:40px auto; padding:0 16px; background:var(--bg); color:#111;
    }

    /* Header */
    .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;
      font-size:20px;background:#fff;border:1px solid var(--line)}
    h1{margin:0}

    /* Chat area */
    .chat{
      border:1px solid var(--line); border-radius:14px; padding:16px; height:480px;
      overflow-y:auto; display:flex; flex-direction:column; gap:8px; background:var(--card);
    }
    .bubble{padding:10px 12px; border-radius:12px; max-width:80%; white-space:pre-wrap; word-break:break-word;}
    .user{background:var(--user); align-self:flex-end;}
    .bot{ background:var(--bot);  align-self:flex-start;}
    .bubble img{max-width:220px; max-height:180px; border-radius:8px; display:block}

    /* Composer */
    .composer{display:flex; gap:10px; align-items:center; margin-top:12px}
    .box{flex:1; display:flex; align-items:center; gap:8px; border:1px solid var(--line);
      background:var(--card); border-radius:14px; padding:8px 12px}
    .attach-btn{border:0; background:transparent; font-size:18px; cursor:pointer; line-height:1; color:#444}
    .attach-btn:hover{color:#000}
    .box input[type="text"]{flex:1; border:0; outline:none; font-size:16px; background:transparent}
    .send-btn{width:44px;height:44px;border-radius:50%;border:0;background:var(--ink);color:#fff;
      font-size:18px;cursor:pointer;display:grid;place-items:center}
    .send-btn[disabled]{opacity:.7; cursor:not-allowed}
    #img{display:none} /* hidden file input */

    /* Small chip preview inside composer */
    .chip{display:flex;align-items:center;gap:6px;padding:4px 6px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .chip img{width:28px;height:28px;object-fit:cover;border-radius:6px;border:1px solid #e6e6e6}
    .chip button{border:0;background:transparent;color:#b91c1c;cursor:pointer;font-size:14px;line-height:1}
    .hidden{display:none}

    /* Typing indicator (three bouncing dots) */
    .typing { color:#555; font-size:13px; }
    .dots{ display:inline-flex; gap:4px; vertical-align:middle; margin-left:4px }
    .dot{ width:6px; height:6px; border-radius:50%; background:#888; opacity:.6; animation: bounce 1s infinite ease-in-out }
    .dot:nth-child(2){ animation-delay:.15s }
    .dot:nth-child(3){ animation-delay:.3s }
    @keyframes bounce{
      0%,80%,100%{ transform: translateY(0); opacity:.6 }
      40%{ transform: translateY(-4px); opacity:1 }
    }

    /* Pop-in animation for new bubbles */
    .pop { animation: popin .18s ease-out both }
    @keyframes popin{
      from{ transform: scale(.97) translateY(6px); opacity:.0 }
      to  { transform: scale(1)    translateY(0);   opacity:1  }
    }

    /* hide session meta completely but keep node for JS */
    .meta{display:none}
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar" aria-hidden="true">üêª</div>
    <h1>Hi!</h1>
  </div>

  <div id="chat" class="chat" aria-label="Chat history"></div>

  <div class="composer">
    <div class="box">
      <button id="attach" class="attach-btn" title="Attach image" aria-label="Attach image">üìé</button>

      <!-- tiny thumbnail chip preview -->
      <div id="chip" class="chip hidden" aria-live="polite">
        <img id="chipImg" alt="selected image preview">
        <button id="chipX" title="Remove">‚úï</button>
      </div>

      <input id="inp" type="text" placeholder="Say something‚Ä¶" aria-label="Message input" />
    </div>
    <button id="send" class="send-btn" aria-label="Send message">‚Æï</button>
    <input id="img" type="file" accept="image/*" />
  </div>

  <!-- keep session id node but hidden so JS doesn‚Äôt error -->
  <div class="meta">Session: <code id="sid"></code></div>

  <script>
    // --- session id (hidden) ---
    let sessionId = localStorage.getItem('session_id');
    if (!sessionId) {
      sessionId = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
      localStorage.setItem('session_id', sessionId);
    }
    document.getElementById('sid').textContent = sessionId;

    // --- elements ---
    const chat   = document.getElementById('chat');
    const inp    = document.getElementById('inp');
    const send   = document.getElementById('send');
    const img    = document.getElementById('img');
    const attach = document.getElementById('attach');

    const chip   = document.getElementById('chip');
    const chipImg= document.getElementById('chipImg');
    const chipX  = document.getElementById('chipX');

    let pendingFile = null;

    function autoscroll(){ chat.scrollTop = chat.scrollHeight; }

    function addTextBubble(text, who){
      const div = document.createElement('div');
      div.className = `bubble ${who} pop`;
      div.textContent = text;
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    function addImageBubble(url, who, alt='image'){
      const div = document.createElement('div');
      div.className = `bubble ${who} pop`;
      const im = document.createElement('img');
      im.src = url; im.alt = alt;
      div.appendChild(im);
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    // typing bubble that we will REPLACE with the final reply
    function showTypingBubble(){
      const div = document.createElement('div');
      div.className = 'bubble bot typing pop';
      div.innerHTML = `Thinking<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      chat.appendChild(div);
      autoscroll();
      return div;
    }

    attach.addEventListener('click', () => img.click());

    function showChip(file){
      if(!file) return;
      pendingFile = file;
      chipImg.src = URL.createObjectURL(file);
      chip.classList.remove('hidden');
    }
    function clearChip(){
      pendingFile = null;
      chipImg.src = '';
      chip.classList.add('hidden');
      img.value = '';
    }
    chipX.addEventListener('click', clearChip);

    img.addEventListener('change', () => {
      const f = img.files && img.files[0] ? img.files[0] : null;
      if (f && f.type.startsWith('image/')) showChip(f);
    });

    async function sendMessage(){
      const text = inp.value.trim();
      const file = pendingFile;

      if (!text && !file) return;

      // optimistic user bubbles with animation
      if (text) addTextBubble(text, 'user');
      if (file) addImageBubble(URL.createObjectURL(file), 'user', file.name);

      inp.value = '';
      send.disabled = true;

      // upload image first (if any)
      let imageUrl = null;
      if (file) {
        const fd = new FormData();
        fd.append('image', file);
        try{
          const up = await fetch('/upload', { method:'POST', body: fd });
          const udata = await up.json();
          if (udata && udata.url) imageUrl = udata.url;
        }catch(e){
          console.error('upload failed', e);
          addTextBubble('Image upload failed.', 'bot');
          send.disabled = false; inp.focus();
          return;
        }
        clearChip();
      }

      // immediately show typing bubble and replace it later
      const typing = showTypingBubble();

      try{
        const res = await fetch('/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: text, session_id: sessionId, image_url: imageUrl })
        });
        const data = await res.json();

        if (data.session_id && data.session_id !== sessionId) {
          sessionId = data.session_id;
          localStorage.setItem('session_id', sessionId);
          document.getElementById('sid').textContent = sessionId;
        }

        // replace typing bubble content with final reply
        const replyText = data.reply || '(no reply)';
        // Try to render catalog cards; if it returns false, fall back to plain text
        if (!tryRenderNumberedCatalog(typing, replyText)) {
          typing.className = 'bubble bot pop';
          typing.textContent = replyText;
        }
      }catch(e){
        console.error(e);
        typing.className = 'bubble bot pop';
        typing.textContent = 'Error contacting server.';
      }finally{
        send.disabled = false;
        inp.focus();
      }
    }

    function tryRenderNumberedCatalog(typingDiv, replyText) {
      if (!replyText) return false;

      // split lines, trim empties
      const rawLines = replyText.split('\n').map(l => l.trim()).filter(Boolean);
      if (!rawLines.length) return false;

      // skip optional "(query: ...)" line
      let i = 0;
      if (/^\(query:\s*.+\)$/i.test(rawLines[0])) i = 1;

      // require the header
      const headerLine = rawLines[i] || "";
      if (!/^Here are some picks from my catalog:/i.test(headerLine)) return false;

      // collect numbered items after the header
      const itemLines = rawLines.slice(i + 1);

      // 1. **Name** ‚Äî $1999 ¬∑ Brand (image: /catalog_images/xxx.jpg)
      const re = /^\s*(\d+)\.\s+\*\*(.+?)\*\*(?:\s+‚Äî\s+\$?([\d.]+))?(?:\s+¬∑\s+([^(]+?))?\s+\(image:\s*(.+?)\s*\)\s*$/;

      const items = [];
      for (const line of itemLines) {
        const m = line.match(re);
        if (!m) continue;
        const idx   = m[1];
        const name  = m[2];
        const price = m[3] ? `$${m[3]}` : '';
        const brand = (m[4] || '').trim();
        const img   = m[5];
        items.push({ idx, name, price, brand, img });
      }
      if (!items.length) return false;

      // build a new bubble that includes the header + grid
      const bubble = document.createElement('div');
      bubble.className = 'bubble bot pop';

      const head = document.createElement('div');
      head.className = 'catalog-header';
      head.textContent = headerLine;
      bubble.appendChild(head);

      const grid = document.createElement('div');
      grid.className = 'catalog-grid';

      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'catalog-card';

        const idx = document.createElement('div');
        idx.className = 'catalog-idx';
        idx.textContent = `${it.idx}.`;

        const im = document.createElement('img');
        im.src = it.img;
        im.alt = it.name;

        const title = document.createElement('div');
        title.className = 'catalog-title';
        title.textContent = it.name;

        const meta = document.createElement('div');
        meta.className = 'catalog-meta';
        meta.textContent = [it.price, it.brand].filter(Boolean).join(' ‚Ä¢ ');

        card.appendChild(idx);
        card.appendChild(im);
        card.appendChild(title);
        card.appendChild(meta);
        grid.appendChild(card);
      });

      bubble.appendChild(grid);
      typingDiv.replaceWith(bubble);
      // autoscroll is already called after replace in your flow
      return true;
    }
    send.addEventListener('click', sendMessage);
    inp.addEventListener('keydown', (e) => e.key === 'Enter' && sendMessage());

    // Greeting
    addTextBubble('üëã Hello! I am BiBi, your personal shopping assistant.\nHow can I help you today? üòò', 'bot');
    setTimeout(() => {
    addTextBubble("‚ú® Here‚Äôs what I can do:\n1Ô∏è‚É£ Chat with you about anything üó£Ô∏è\n2Ô∏è‚É£ Suggest awesome products üéÅ\n3Ô∏è‚É£ Search by image üîç Just upload and I‚Äôll find it!", 'bot');
  }, 800);
  </script>
</body>
</html>